{% extends "base.html" %}
{% load static %}
{% block content %}
<div class="flex items-center justify-between mb-6">
    <h2 class="text-3xl font-semibold">Network Overview</h2>

    {% if user.is_authenticated %}
        <div class="flex items-center space-x-4">
            <span class="text-gray-300">
                Logged in as <span class="font-semibold">{{ user.username }}</span>
            </span>
            <a href="{% url 'account_logout' %}"
               class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg transition">
               Logout
            </a>
        </div>
    {% endif %}
</div>

<div class="grid grid-cols-1 gap-6">

    <!-- Current Network Status Card -->
    <div class="bg-gray-800 rounded-2xl shadow p-6 hover:shadow-lg transition">
        <h3 class="text-xl font-bold mb-4">Current Network Status</h3>

        <!-- Current Metrics Grid -->
        {% if network_metrics %}
        <div class="grid grid-cols-4 gap-4 mb-4">
            <div class="rounded p-4 {% if network_metrics.tcp_latency > 5 %}bg-red-700{% else %}bg-green-700{% endif %}">
                <span class="font-bold text-2xl">
                    {{ network_metrics.tcp_latency|floatformat:1 }} ms
                </span><br>
                <span class="text-gray-300 text-sm">TCP Latency</span>
            </div>
            <div class="rounded p-4 {% if network_metrics.internet_ping > 50 %}bg-red-700{% else %}bg-green-700{% endif %}">
                <span class="font-bold text-2xl">
                    {{ network_metrics.internet_ping|floatformat:1 }} ms
                </span><br>
                <span class="text-gray-300 text-sm">Ping</span>
            </div>
            <div class="rounded p-4 {% if network_metrics.internet_download < 250 %}bg-red-700{% else %}bg-green-700{% endif %}">
                <span class="font-bold text-2xl">
                    {{ network_metrics.internet_download|floatformat:1 }} Mbps
                </span><br>
                <span class="text-gray-300 text-sm">Download</span>
            </div>
            <div class="rounded p-4 {% if network_metrics.internet_upload < 20 %}bg-red-700{% else %}bg-green-700{% endif %}">
                <span class="font-bold text-2xl">
                    {{ network_metrics.internet_upload|floatformat:1 }} Mbps
                </span><br>
                <span class="text-gray-300 text-sm">Upload</span>
            </div>
        </div>

        <!-- Status Info -->
        <div class="grid grid-cols-1 gap-4 text-sm text-gray-300">
            <div>
                <span class="font-semibold text-gray-200">Online:</span>
                {% if network_metrics.online %}
                    <span class="text-green-400 font-semibold">✅ Yes</span>
                {% else %}
                    <span class="text-red-400 font-semibold">❌ No</span>
                {% endif %}
            </div>
        </div>
        {% else %}
        <div class="text-gray-400">No network data available</div>
        {% endif %}
    </div>

    <!-- Monthly Download/Upload Performance Chart -->
    <div class="bg-gray-800 rounded-2xl shadow p-6 hover:shadow-lg transition" style="min-height: 28rem;">
        <h3 class="text-xl font-bold mb-4">Download & Upload Performance (Monthly)</h3>

        <!-- Month/Year Selector -->
        <div class="mb-4 flex items-center gap-4">
            <form method="GET" class="flex items-center gap-2">
                <label for="month_select" class="text-gray-300">Month:</label>
                <select id="month_select" name="month" class="bg-gray-700 text-white px-3 py-2 rounded"
                        onchange="updateMonthSelection()">
                    <option value="1" {% if selected_month == 1 %}selected{% endif %}>January</option>
                    <option value="2" {% if selected_month == 2 %}selected{% endif %}>February</option>
                    <option value="3" {% if selected_month == 3 %}selected{% endif %}>March</option>
                    <option value="4" {% if selected_month == 4 %}selected{% endif %}>April</option>
                    <option value="5" {% if selected_month == 5 %}selected{% endif %}>May</option>
                    <option value="6" {% if selected_month == 6 %}selected{% endif %}>June</option>
                    <option value="7" {% if selected_month == 7 %}selected{% endif %}>July</option>
                    <option value="8" {% if selected_month == 8 %}selected{% endif %}>August</option>
                    <option value="9" {% if selected_month == 9 %}selected{% endif %}>September</option>
                    <option value="10" {% if selected_month == 10 %}selected{% endif %}>October</option>
                    <option value="11" {% if selected_month == 11 %}selected{% endif %}>November</option>
                    <option value="12" {% if selected_month == 12 %}selected{% endif %}>December</option>
                </select>

                <label for="year_select" class="text-gray-300 ml-4">Year:</label>
                <select id="year_select" name="year" class="bg-gray-700 text-white px-3 py-2 rounded"
                        onchange="updateMonthSelection()">
                    <option value="2023" {% if selected_year == 2023 %}selected{% endif %}>2023</option>
                    <option value="2024" {% if selected_year == 2024 %}selected{% endif %}>2024</option>
                    <option value="2025" {% if selected_year == 2025 %}selected{% endif %}>2025</option>
                    <option value="2026" {% if selected_year == 2026 %}selected{% endif %}>2026</option>
                </select>
            </form>
        </div>

        <!-- Monthly Speed Stats -->
        <div class="mb-6 grid grid-cols-2 gap-4">
            <div class="bg-gray-700 rounded-lg p-4">
                <p class="text-gray-400 text-sm">Average Download (Mbps)</p>
                <p class="text-2xl font-bold text-blue-400" id="avgDownload">-</p>
            </div>
            <div class="bg-gray-700 rounded-lg p-4">
                <p class="text-gray-400 text-sm">Average Upload (Mbps)</p>
                <p class="text-2xl font-bold text-purple-400" id="avgUpload">-</p>
            </div>
        </div>

        <div class="w-full h-96">
            <canvas id="networkSpeedChart" class="w-full h-full"></canvas>
        </div>
    </div>

    <!-- Monthly Latency Performance Chart -->
    <div class="bg-gray-800 rounded-2xl shadow p-6 hover:shadow-lg transition" style="min-height: 28rem;">
        <h3 class="text-xl font-bold mb-4">Latency Performance (Monthly)</h3>

        <!-- Monthly Latency Stats -->
        <div class="mb-6 grid grid-cols-2 gap-4">
            <div class="bg-gray-700 rounded-lg p-4">
                <p class="text-gray-400 text-sm">Average Ping (ms)</p>
                <p class="text-2xl font-bold text-green-400" id="avgPing">-</p>
            </div>
            <div class="bg-gray-700 rounded-lg p-4">
                <p class="text-gray-400 text-sm">Average TCP Latency (ms)</p>
                <p class="text-2xl font-bold text-yellow-400" id="avgTcpLatency">-</p>
            </div>
        </div>

        <div class="w-full h-96">
            <canvas id="networkLatencyChart" class="w-full h-full"></canvas>
        </div>
    </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="{% static 'dashboard/dashboard.js' %}?v=2"></script>
<script>
    const networkMonthlyMetrics = {{ network_monthly_metrics|safe }};

    // Define chart rendering functions inline
    function renderNetworkSpeedChart(canvasId, metrics) {
        const labels = metrics.map(m => m.date);
        const download = metrics.map(m => m.download);
        const upload = metrics.map(m => m.upload);

        const ctx = document.getElementById(canvasId).getContext('2d');
        return new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Download',
                        data: download,
                        fill: true,
                        borderColor: 'rgba(59,130,246,1)',
                        backgroundColor: 'rgba(59,130,246,0.2)',
                        tension: 0.2,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    },
                    {
                        label: 'Upload',
                        data: upload,
                        fill: true,
                        borderColor: 'rgba(168,85,247,1)',
                        backgroundColor: 'rgba(168,85,247,0.2)',
                        tension: 0.2,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Date',
                            color: 'white',
                            font: { size: 16, weight: 'bold' }
                        },
                        ticks: {
                            color: 'white',
                            font: { size: 14 }
                        },
                        grid: {
                            color: 'rgba(255,255,255,0.2)'
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Mbps',
                            color: 'white',
                            font: { size: 16, weight: 'bold' }
                        },
                        ticks: {
                            color: 'white',
                            font: { size: 14 }
                        },
                        grid: {
                            color: 'rgba(255,255,255,0.2)'
                        },
                        beginAtZero: true
                    }
                },
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            color: 'white',
                            font: { size: 14 }
                        }
                    },
                    title: {
                        display: false
                    }
                }
            }
        });
    }

    function renderNetworkLatencyChart(canvasId, metrics) {
        const labels = metrics.map(m => m.date);
        const ping = metrics.map(m => m.ping);
        const tcpLatency = metrics.map(m => m.tcp_latency);

        const ctx = document.getElementById(canvasId).getContext('2d');
        return new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Ping',
                        data: ping,
                        fill: true,
                        borderColor: 'rgba(34,197,94,1)',
                        backgroundColor: 'rgba(34,197,94,0.2)',
                        tension: 0.2,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    },
                    {
                        label: 'TCP Latency',
                        data: tcpLatency,
                        fill: true,
                        borderColor: 'rgba(234,179,8,1)',
                        backgroundColor: 'rgba(234,179,8,0.2)',
                        tension: 0.2,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Date',
                            color: 'white',
                            font: { size: 16, weight: 'bold' }
                        },
                        ticks: {
                            color: 'white',
                            font: { size: 14 }
                        },
                        grid: {
                            color: 'rgba(255,255,255,0.2)'
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'ms',
                            color: 'white',
                            font: { size: 16, weight: 'bold' }
                        },
                        ticks: {
                            color: 'white',
                            font: { size: 14 }
                        },
                        grid: {
                            color: 'rgba(255,255,255,0.2)'
                        },
                        beginAtZero: true
                    }
                },
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            color: 'white',
                            font: { size: 14 }
                        }
                    },
                    title: {
                        display: false
                    }
                }
            }
        });
    }

    // Render the charts
    if (networkMonthlyMetrics && networkMonthlyMetrics.length > 0) {
        renderNetworkSpeedChart("networkSpeedChart", networkMonthlyMetrics);
        renderNetworkLatencyChart("networkLatencyChart", networkMonthlyMetrics);
    } else {
        console.log('No network data available for the selected month');
    }

    // Calculate and display averages
    if (networkMonthlyMetrics.length > 0) {
        const avgDownload = networkMonthlyMetrics.reduce((sum, m) => sum + (m.download || 0), 0) / networkMonthlyMetrics.length;
        const avgUpload = networkMonthlyMetrics.reduce((sum, m) => sum + (m.upload || 0), 0) / networkMonthlyMetrics.length;
        const avgPing = networkMonthlyMetrics.reduce((sum, m) => sum + (m.ping || 0), 0) / networkMonthlyMetrics.length;
        const avgTcpLatency = networkMonthlyMetrics.reduce((sum, m) => sum + (m.tcp_latency || 0), 0) / networkMonthlyMetrics.length;

        document.getElementById('avgDownload').textContent = avgDownload.toFixed(2);
        document.getElementById('avgUpload').textContent = avgUpload.toFixed(2);
        document.getElementById('avgPing').textContent = avgPing.toFixed(2);
        document.getElementById('avgTcpLatency').textContent = avgTcpLatency.toFixed(2);
    }

    function updateMonthSelection() {
        const monthForm = document.querySelector('form');
        monthForm.submit();
    }
</script>

{% endblock %}
