{% extends "base.html" %}
{% load static %}
{% block content %}
<div class="flex items-center justify-between mb-6">
    <h2 class="text-3xl font-semibold">HomeLab Overview</h2>
    
    {% if user.is_authenticated %}
        <div class="flex items-center space-x-4">
            <span class="text-gray-300">
                Logged in as <span class="font-semibold">{{ user.username }}</span>
            </span>
            <a href="{% url 'account_logout' %}"
               class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg transition">
               Logout
            </a>
        </div>
    {% endif %}
</div>

<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
    <!-- Kubernetes Overview Card -->
    <div class="bg-gray-800 rounded-2xl shadow p-6 row-span-1 sm:row-span-2 lg:row-span-2">
        <h3 class="text-xl font-bold mb-4 flex justify-between items-center">
            <span>Kubernetes Overview</span>
            <span class="text-lg text-gray-300 font-semibold">
            Total Pods: {{ total_pods }}
            </span>
        </h3>

        <!-- Pod Status Breakdown -->
        <div class="mb-4">
            <h4 class="text-md font-semibold text-gray-200 mb-2">Pods Status</h4>
            <div class="grid grid-cols-3 gap-2 text-center">
                <div class="bg-green-700 rounded p-2">
                    <span class="font-bold">{{ pods.running }}</span><br>
                    <span class="text-gray-300 text-sm">Running</span>
                </div>
                {% if pods.pending > 0 %}
                <div class="bg-yellow-600 rounded p-2">
                    <span class="font-bold">{{ pods.pending }}</span><br>
                    <span class="text-gray-300 text-sm">Pending</span>
                </div>
                {% endif %}
        
                {% if pods.failed > 0 %}
                <div class="bg-red-700 rounded p-2">
                    <span class="font-bold">{{ pods.failed }}</span><br>
                    <span class="text-gray-300 text-sm">Failed</span>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Node Summary Table -->
        <h4 class="text-md font-semibold text-gray-200 mb-2">Node Summary</h4>
        <div class="overflow-x-auto">
            <table class="w-full text-left table-auto">
            <thead>
                <tr class="text-gray-300 text-sm border-b border-gray-700">
                <th class="px-2 py-1">Node</th>
                <th class="px-2 py-1">CPU Alloc / Cap</th>
                <th class="px-2 py-1">CPU %</th>
                <th class="px-2 py-1">Mem Alloc / Cap (GiB)</th>
                <th class="px-2 py-1">Mem %</th>
                <th class="px-2 py-1">Status</th>
                </tr>
            </thead>
            <tbody>
                {% for node in nodes %}
                <tr class="text-gray-200 text-sm border-b border-gray-700">
                <td class="px-2 py-1">{{ node.name }}</td>
                <td class="px-2 py-1">{{ node.cpu_allocatable }} / {{ node.cpu_capacity }}</td>
                <td class="px-2 py-1 {% if node.cpu_percent >= 85 %}font-bold text-red-400{% elif node.cpu_percent >= 70 %}font-bold text-yellow-400{% endif %}">
                    {{ node.cpu_percent }}%
                </td>
                <td class="px-2 py-1">{{ node.mem_usage }} / {{ node.mem_allocatable }}</td>
                <td class="px-2 py-1 {% if node.mem_percent >= 85 %}font-bold text-red-400{% elif node.mem_percent >= 70 %}font-bold text-yellow-400{% endif %}">
                    {{ node.mem_percent }}%
                </td>
                <td class="px-2 py-1">
                    {% if node.ready %}
                    <span class="text-green-400 font-semibold">Ready</span>
                    {% else %}
                    <span class="text-red-400 font-semibold">NotReady</span>
                    {% endif %}
                </td>
                </tr>
                {% endfor %}
            </tbody>
            </table>
        </div>

        <!-- Cluster Load -->
        <div class="mt-4 flex gap-4 justify-around">
            <div class="text-center">
            <span class="block text-gray-300 text-sm">CPU Load</span>
            <span class="block font-bold text-lg">{{ cluster_cpu_percent }}%</span>
            </div>
            <div class="text-center">
            <span class="block text-gray-300 text-sm">Memory Load</span>
            <span class="block font-bold text-lg">{{ cluster_mem_percent }}%</span>
            </div>
        </div>
    </div>

    <!-- Synology NAS Overview Card -->
    <div class="bg-gray-800 rounded-2xl shadow p-6 row-span-1 sm:row-span-2 lg:row-span-2">
        <h3 class="text-xl font-bold mb-4 flex justify-between items-center">
            <span>Synology NAS Overview</span>
            <span class="text-lg text-gray-300 font-semibold">
                Model: {{ synology_metrics.model }}
            </span>
        </h3>

        <!-- CPU / Memory / Storage Status -->
        <div class="mb-4">
            <h4 class="text-md font-semibold text-gray-200 mb-2">Health Overview</h4>
            <div class="grid grid-cols-3 gap-2 text-center">
                <!-- CPU -->
                <div class="rounded p-2 {% if synology_metrics.utilization.cpu_percent >= 85 %}bg-red-700{% elif synology_metrics.utilization.cpu_percent >= 70 %}bg-yellow-600{% else %}bg-green-700{% endif %}">
                    <span class="font-bold text-lg">{{ synology_metrics.cpu_percent }}%</span><br>
                    <span class="text-gray-300 text-sm">CPU Usage</span>
                </div>

                <!-- Memory -->
                <div class="rounded p-2 {% if synology_metrics.utilization.memory_percent >= 85 %}bg-red-700{% elif synology_metrics.utilization.memory_percent >= 70 %}bg-yellow-600{% else %}bg-green-700{% endif %}">
                    <span class="font-bold text-lg">{{ synology_metrics.memory_percent }}%</span><br>
                    <span class="text-gray-300 text-sm">Memory Usage</span>
                </div>

                <!-- Disk -->
                <div class="rounded p-2 {% if synology_metrics.utilization.memory_percent >= 85 %}bg-red-700{% elif synology_metrics.utilization.memory_percent >= 70 %}bg-yellow-600{% else %}bg-green-700{% endif %}">
                    <span class="font-bold text-lg">{{ synology_metrics.overall_percent_used }}%</span><br>
                    <span class="text-gray-300 text-sm">Disk Usage</span>
                </div>
            </div>
        </div>

        <!-- Volume Summary Table -->
        <h4 class="text-md font-semibold text-gray-200 mb-2">Volume Summary</h4>
        <div class="overflow-x-auto">
            <table class="w-full text-left table-auto">
            <thead>
                <tr class="text-gray-300 text-sm border-b border-gray-700">
                <th class="px-2 py-1">Volume</th>
                <th class="px-2 py-1 text-center">Size</th>
                <th class="px-2 py-1 text-center">Used</th>
                <th class="px-2 py-1 text-center">Storage %</th>
                <th class="px-2 py-1 text-center">Status</th>
                </tr>
            </thead>
            <tbody>
                {% for vol in synology_metrics.volumes %}
                <tr class="text-gray-200 text-sm border-b border-gray-700">
                <td class="px-2 py-1">{{ vol.name }}</td>
                <td class="px-2 py-1 text-center">{{ vol.size_total }}</td>
                <td class="px-2 py-1 text-center">{{ vol.size_used }}</td>
                <td class="px-2 py-1 text-center {% if node.cpu_percent >= 85 %}font-bold text-red-400{% elif node.cpu_percent >= 70 %}font-bold text-yellow-400{% endif %}">
                    {{ vol.percent_used }}%
                </td>
                <td class="px-2 py-1 text-center">
                    {% if vol.status and vol.status == 'normal' %}
                    <span class="text-green-400 font-semibold">{{ vol.status }}</span>
                    {% else %}
                    <span class="text-red-400 font-semibold">{{ vol.status }}</span>
                    {% endif %}
                </td>                
                </tr>
                {% endfor %}
            </tbody>
            </table>
        </div>
        <br />
        <!-- Disk Summary Table -->
        <h4 class="text-md font-semibold text-gray-200 mb-2">Disk Summary</h4>
        <div class="overflow-x-auto">
            <table class="w-full text-left table-auto">
            <thead>
                <tr class="text-gray-300 text-sm border-b border-gray-700">
                <th class="px-2 py-1">Disk</th>
                <th class="px-2 py-1 text-center">Name</th>
                <th class="px-2 py-1 text-center">Tempature</th>
                <th class="px-2 py-1 text-center">Status</th>
                </tr>
            </thead>
            <tbody>
                {% for disk in synology_metrics.disks %}
                <tr class="text-gray-200 text-sm border-b border-gray-700">
                <td class="px-2 py-1">{{ disk.id }}</td>
                <td class="px-2 py-1 text-center">{{ disk.name }}</td>
                <td class="px-2 py-1 text-center">{{ disk.temperature }}</td>
                <td class="px-2 py-1 text-center">
                    {% if disk.smart_status and disk.smart_status == 'normal' %}
                    <span class="text-green-400 font-semibold">{{ disk.smart_status }}</span>
                    {% else %}
                    <span class="text-red-400 font-semibold">{{ disk.smart_status }}</span>
                    {% endif %}
                </td>                
                </tr>
                {% endfor %}
            </tbody>
            </table>
        </div>      

        <!--  Network Info and Uptime -->
        <div class="mt-4 flex gap-4 justify-around">
            <div class="text-center">
                <span class="block text-gray-300 text-sm">Net Up</span>
                <span class="block font-bold text-lg">{{ synology_metrics.net_up|filesizeformat }}/s</span>
            </div>
            <div class="text-center">
                <span class="block text-gray-300 text-sm">Net Down</span>
                <span class="block font-bold text-lg">{{ synology_metrics.net_down|filesizeformat }}/s</span>
            </div>
            <div class="text-center">
                <span class="block text-gray-300 text-sm">Uptime</span>
                <span class="block font-bold text-lg">{{ synology_metrics.uptime_days }}d {{ synology_metrics.uptime_hours }}h {{ synology_metrics.uptime_minutes }}m</span>
            </div>
        </div>


    </div>

    <!-- Network Overview Card -->
    <div class="bg-gray-800 rounded-2xl shadow p-6 row-span-1 sm:row-span-2 lg:row-span-2">
        <h3 class="text-xl font-bold mb-4 flex justify-between items-center">
            <span>Network Overview</span>
        </h3>

        <!-- Devices / Metrics -->
        <div class="mb-4">
            <div class="grid grid-cols-4 gap-2 text-center">
                <div class="rounded p-2 {% if network_metrics.tcp_latency > 5 %}bg-red-700{% else %}bg-green-700{% endif %}">
                    <span class="font-bold">
                        {{ network_metrics.tcp_latency|floatformat:1 }} ms
                    </span><br>
                    <span class="text-gray-300 text-sm">TCP Latency</span>
                </div>
                <div class="rounded p-2 {% if network_metrics.internet_ping > 50 %}bg-red-700{% else %}bg-green-700{% endif %}">
                    <span class="font-bold">
                        {{ network_metrics.internet_ping|floatformat:1 }} ms
                    </span><br>
                    <span class="text-gray-300 text-sm">Ping</span>
                </div>
                <div class="rounded p-2 {% if network_metrics.internet_download < 250 %}bg-red-700{% else %}bg-green-700{% endif %}">
                    <span class="font-bold">
                        {{ network_metrics.internet_download|floatformat:1 }} Mbps
                    </span><br>
                    <span class="text-gray-300 text-sm">Download</span>
                </div>
                <div class="rounded p-2 {% if network_metrics.internet_upload < 20 %}bg-red-700{% else %}bg-green-700{% endif %}">
                    <span class="font-bold">
                        {{ network_metrics.internet_upload|floatformat:1 }} Mbps
                    </span><br>
                    <span class="text-gray-300 text-sm">Upload</span>
                </div>
            </div>
        </div>

        <!-- Status Grid -->
        <div class="grid grid-cols-1 gap-4 text-sm text-gray-300 mb-4">
            <div>
                <span class="font-semibold text-gray-200">Online:</span>
                {% if network_metrics.online %}
                    <span class="text-green-400 font-semibold">✅ Yes</span>
                {% else %}
                    <span class="text-red-400 font-semibold">❌ No</span>
                {% endif %}
            </div>
            <div>
                <span class="font-semibold text-gray-200">Ethernet Link:</span>
                {% if network_metrics.ethernet_link %}
                    <span class="text-green-400 font-semibold">✅ Up</span>
                {% else %}
                    <span class="text-red-400 font-semibold">❌ Down</span>
                {% endif %}
            </div>
            <div>
                <span class="font-semibold text-gray-200">LED Status:</span>
                {{ network_metrics.led_status }}
            </div>
            <div>
                <span class="font-semibold text-gray-200">IP Method:</span>
                {{ network_metrics.ip_method }}
            </div>
            <div>
                <span class="font-semibold text-gray-200">IP Address:</span>
                {{ network_metrics.ip_address }}
            </div>
            <div>
                <span class="font-semibold text-gray-200">Local IP Address:</span>
                {{ network_metrics.local_ip_address }}
            </div>
            <div>
                <span class="font-semibold text-gray-200">Gateway:</span>
                {{ network_metrics.gateway }}
            </div>
            <div>
                <span class="font-semibold text-gray-200">DNS Servers:</span>
                {{ network_metrics.dns_servers }}
            </div>
            <div>
                <span class="font-semibold text-gray-200">DNS Resolution:</span>
                {{ network_metrics.dns }}
            </div>
            <div>
                <span class="font-semibold text-gray-200">Lease Duration:</span>
                {{ network_metrics.lease_days }}d {{ network_metrics.lease_hours }}h {{ network_metrics.lease_minutes }}m
            </div>
            <div>
                <span class="font-semibold text-gray-200">Uptime:</span>
                {{ network_metrics.uptime_days }}d {{ network_metrics.uptime_hours }}h {{ network_metrics.uptime_minutes }}m
            </div>
            <div>
                <span class="font-semibold text-gray-200">Update Required:</span>
                {% if network_metrics.update_required %}
                    <span class="text-red-400 font-semibold">Yes</span>
                {% else %}
                    <span class="text-green-400 font-semibold">No</span>
                {% endif %}
            </div>
        </div>
    </div>


    <!-- Collector Job Summary Table -->
    <div class="bg-gray-800 rounded-2xl shadow p-6 hover:shadow-lg transition">
        <h3 class="text-xl font-bold mb-4">Collector Job Summary: Last 24 hours</h3>
        <div class="overflow-x-auto">
            <table class="w-full text-left table-auto">
                <thead>
                    <tr class="text-gray-300 text-sm border-b border-gray-700">
                        <th class="px-2 py-1">Component</th>
                        <th class="px-2 py-1">Return Code</th>
                        <th class="px-2 py-1 text-right">Count</th>
                        <th class="px-2 py-1 text-right">Duration (s)</th>
                        <th class="px-2 py-1">Last Run (EST)</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in splunk_summary %}
                    <tr class="text-sm border-b border-gray-700">
                        <td class="px-2 py-1 font-semibold text-gray-200">{{ item.component }}</td>
                        <td class="px-2 py-1">
                            {% if item.is_bad_return_code %}
                                <span class="text-red-400 font-semibold">❌ {{ item.return_code }}</span>
                            {% else %}
                                <span class="text-green-400 font-semibold">✅ {{ item.return_code }}</span>
                            {% endif %}
                        </td>                        
                    </td>
                        <td class="px-2 py-1 text-right">{{ item.count }}</td>
                        <td class="px-2 py-1 text-center">{{ item.duration }}</td>
                        <td class="px-2 py-1">
                            {% if item.is_stale %}
                                <span class="text-red-400 font-semibold">❌ {{ item.last_run_est }}</span>
                            {% else %}
                                <span class="text-green-400 font-semibold">✅ {{ item.last_run_est }}</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    

            <!-- Weather Card -->
            <div class="bg-gray-800 rounded-2xl shadow p-6">
            
            <h3 class="text-xl font-bold mb-4 flex justify-between items-center">
                <span>Weather Overview</span>
                {% if weather_summary %}
                    <span class="text-lg text-gray-300 font-semibold">
                        {{ weather_summary.weather.collection_time|date:"M d, Y H:i" }}
                    </span>
                {% else %}
                <span class="text-lg text-gray-300 font-semibold">
                    There were no weather results found
                </span>
            {% endif %}
            </h3>
        
            {% if weather_summary %}
                <!-- Current Weather -->
                <div class="mb-6 grid grid-cols-3 gap-4 text-center">
                    <div class="bg-blue-700 rounded p-4">
                        <span class="block font-bold text-2xl">{{ weather_summary.weather.temperature }}°F</span>
                        <span class="text-gray-300 text-sm">Current Temp</span>
                    </div>
                    <div class="bg-green-700 rounded p-4">
                        <span class="block font-bold text-lg">{{ weather_summary.weather.temperature_min }}°F / {{ weather_summary.weather.temperature_max }}°F</span>
                        <span class="text-gray-300 text-sm">Low / High</span>
                    </div>
                    <div class="bg-purple-700 rounded p-4">
                        <span class="block font-bold text-lg">{{ weather_summary.weather.humidity }}%</span>
                        <span class="text-gray-300 text-sm">Humidity</span>
                    </div>
                </div>
            
                <!-- Extra Weather Details -->
                <div class="grid grid-cols-3 gap-4 text-center mb-6">
                    <div class="bg-gray-700 rounded p-2">
                        <span class="block font-bold">{{ weather_summary.weather.feels_like }}°F</span>
                        <span class="text-gray-300 text-sm">Feels Like</span>
                    </div>
                    <div class="bg-gray-700 rounded p-2">
                        <span class="block font-bold">{{ weather_summary.weather.wind_speed }} mph</span>
                        <span class="text-gray-300 text-sm">Wind Speed</span>
                    </div>
                    <div class="bg-gray-700 rounded p-2">
                        <span class="block font-bold">{{ weather_summary.weather.wind_direction }}°</span>
                        <span class="text-gray-300 text-sm">Wind Dir</span>
                    </div>
                </div>
            
                <!-- Forecast Table -->
                <h4 class="text-md font-semibold text-gray-200 mb-2">Forecast</h4>
                <div class="overflow-x-auto">
                    <table class="w-full text-left table-auto">
                        <thead>
                            <tr class="text-gray-300 text-sm border-b border-gray-700">
                                <th class="px-2 py-1">Date</th>
                                <th class="px-2 py-1 text-center">Temperature</th>
                                <th class="px-2 py-1 text-center">Humidity</th>
                                <th class="px-2 py-1">Description</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for f in weather_summary.forecast %}
                            <tr class="text-gray-200 text-sm border-b border-gray-700">
                                <td class="px-2 py-1">{{ f.forecast_date }}</td>
                                <td class="px-2 py-1 text-center">{{ f.temperature_max }}°F</td>
                                <td class="px-2 py-1 text-center">{{ f.humidity_max }}%</td>
                                <td class="px-2 py-1 capitalize">{{ f.description }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% endif %}
        </div>
  
    


    <div class="bg-gray-800 rounded-2xl shadow p-6 hover:shadow-lg transition" style="min-height: 24rem;">
        <h3 class="text-xl font-bold mb-4">Electricity Produced and Usage by Day</h3>
        <div class="w-full h-72">
            <canvas id="emporiaUsageChart" class="h-50 relative"></canvas>
        </div>
    </div>


    <div class="bg-gray-800 rounded-2xl shadow p-6 hover:shadow-lg transition col-span-1 sm:col-span-2 lg:col-span-2" style="min-height: 24rem;">
        <h3 class="text-xl font-bold mb-4">501 Single Out - Average 3 Dart Score</h3>
        <div class="w-full h-72">
            <canvas id="dartChart501" class="w-full h-full"></canvas>
        </div>
    </div>

    <!-- Emporia Daily Summary Table -->
    <div class="bg-gray-800 rounded-2xl shadow p-6 hover:shadow-lg transition">
        {% with emporia_daily_summary|first as first_item %}
            <h3 class="text-xl font-bold mb-4">
                Electricity Daily Usage: <span class="text-green-400 ml-2">{{ first_item.date }}</span>
            </h3>
        {% endwith %}
        <h4 class="text-md font-semibold text-gray-200 mb-2">Daily Usage Summary</h4>
        <div class="overflow-x-auto">
            <table class="w-full text-left table-auto">
                <thead>
                    <tr class="text-gray-300 text-sm border-b border-gray-700">
                        <th class="px-2 py-1">Name</th>
                        <th class="px-2 py-1 text-right">Usage (kWh)</th>
                        <th class="pl-5 pr-2 py-1 text-right">Cost</th>
                        <th class="px-2 py-1 text-right">Percentage</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in emporia_daily_summary %}
                    <tr class="text-gray-200 text-sm border-b border-gray-700">
                        <td class="px-2 py-1">{{ item.name }}</td>
                        <td class="px-2 py-1 text-right">{{ item.usage|floatformat:2 }}</td>
                        <td class="pl-5 pr-2 py-1 text-right">${{ item.cost|floatformat:2 }}</td>
                        <td class="px-2 py-1 text-right">{{ item.percentage|floatformat:1 }}%</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    
    <div class="bg-gray-800 rounded-2xl shadow p-6 hover:shadow-lg transition col-span-1 sm:col-span-2 lg:col-span-2" style="min-height: 24rem;">
        <h3 class="text-xl font-bold mb-4">Score Training - Average 3 Dart Score</h3>
        <div class="w-full h-72">
            <canvas id="dartChartScoreTraining" class="h-50 relative"></canvas>
        </div>
    </div>
      
</div>


<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
<script src="{% static 'dashboard/dashboard.js' %}"></script>
<script>
    const avgScores501 = {{ dart_avg_scores_501|safe }};
    const avgScoreScoreTraining = {{ dart_avg_scores_score_training|safe }};
    const emporiaMetrics = {{ emporia_metrics|safe }};
    const enphaseMetrics = {{ enphase_metrics|safe }};
    renderDartChart('dartChart501', avgScores501);
    renderDartChart('dartChartScoreTraining', avgScoreScoreTraining);
    renderEmporiaUsageChart("emporiaUsageChart", emporiaMetrics);
    renderEnphaseChart("enphaseChart", enphaseMetrics);

</script>
{% endblock %}

